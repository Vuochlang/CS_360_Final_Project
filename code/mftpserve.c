#include "mftp.h"int portNumber = 49999;bool debug = false;int max = 200;char hostName[120] = {};void createSever();bool isNumber(const char argv[]);int commandD(int sockfd, struct sockaddr_in);bool cdCommand(char *path);void commandC(int sockfd, char *path);void commandL(int sockfd);void commandG(int sockfd, char *path);void commandP(int sockfd, char *path);int main(int argc, char const *argv[]) {    bool error = true;    if (argc == 1)        error = false;    else if (argc == 2 && strcmp("-d", argv[1]) == 0) {        error = false;        debug = setDebug(0);    }    else if (argc == 3 && strcmp("-p", argv[1]) == 0 && isNumber(argv[2])) {        portNumber = atoi(argv[2]);        error = false;    }    else if (argc == 4 && strcmp("-d", argv[1]) == 0) {        debug = setDebug(0);        if (strcmp("-p", argv[2]) == 0 && isNumber(argv[3])) {            portNumber = atoi(argv[3]);            error = false;        }    }    else if (argc == 4 && strcmp("-p", argv[1]) == 0 && isNumber(argv[2])) {        portNumber = atoi(argv[2]);        if (strcmp("-d", argv[3]) == 0) {            debug = setDebug(0);            error = false;        }    }    if (error) {        printf("Usage: ./mftpserve [-d] [-p PORT_NUMBER]\n");        printf("    where: [commands] are optional\n");        return 0;    }    else {        createSever();    }    return 0;}void createSever() {    int socketFd, listenFd;    struct sockaddr_in servAddr, clientAddr;    int length = sizeof(struct sockaddr_in);    // make a socket    socketFd = socket(AF_INET, SOCK_STREAM, 0);    if (socketFd < 0) {        fprintf(stderr, "Error: %s\n", strerror(errno));        exit(1);    }    if (setsockopt(socketFd, SOL_SOCKET, SO_REUSEADDR, &(int){1}, sizeof(int)) < 0) {        fprintf(stderr, "Error: %s\n", strerror(errno));        exit(1);    }    if (debug)        printf("Parent: socket created with descriptor %d\n", socketFd);    // Bind the socket to a port    memset(&servAddr, 0, sizeof(servAddr));    servAddr.sin_family = AF_INET;    servAddr.sin_port = htons(portNumber);    servAddr.sin_addr.s_addr = htonl(INADDR_ANY);    if (bind(socketFd, (struct sockaddr *) &servAddr, sizeof(servAddr)) < 0) {        fprintf(stderr, "Error: %s\n", strerror(errno));        exit(1);    }    if (debug)        printf("Parent: socket bound to port %d\n", portNumber);    // Listen and Accept connections    if (listen(socketFd, 4) < 0) {        fprintf(stderr, "Error: %s\n", strerror(errno));        exit(1);    }    if (debug)        printf("Parent: listening with connection queue of 4\n");    while(1) {        if ((listenFd = accept(socketFd, (struct sockaddr *) &clientAddr,                               &length)) < 0) {            fprintf(stderr, "Error: %s\n", strerror(errno));            exit(1);        }        if (debug)            printf("Parent: accepted client connection with descriptor %d\n", listenFd);        bool isExit = false;        int pid = fork();        int status;        if (pid == 0) {            printf("Child %d: started\n", getpid());            int hostEntry;            hostEntry = getnameinfo((struct sockaddr *) &clientAddr,                                    sizeof(clientAddr),                                    hostName,                                    sizeof(hostName),                                    NULL,                                    0,                                    NI_NUMERICSERV);            if (hostEntry != 0) {                fprintf(stderr, "Error: %s\n", gai_strerror(hostEntry));            }            char *clientIp = inet_ntoa(clientAddr.sin_addr);            printf("Child %d: Client IP address -> %s\n", getpid(), clientIp);            printf("Child %d: Connection accepted from host %s\n", getpid(), clientIp);            close(socketFd);            char command[max];            int readResult;            bzero(command, max);            while ((readResult = read(listenFd, command, max)) > 0) {                if (strlen(command) > 0) {                    if (strcmp("E", command) == 0) {                        printf("Parent detected termination of child process %d, exit code: 0\n", getpid());                        exit(EXIT_SUCCESS);                    }                    else if (strcmp("Q", command) == 0) {                        printf("Child %d: Quitting\n", getpid());                        write(listenFd, "A", 1);                        if (debug) {                            printf("Child %d: Sending positive acknowledgement\n",                                   getpid());                            printf("Child %d: exiting normally.\n", getpid());                        }                        close(listenFd);                        exit(EXIT_SUCCESS);                    }                    else if (strncmp("C", command, 1) == 0) {                            char* temp = command + 1;                            char path[strlen(command) - 1];                            strcpy(path, temp);                            commandC(listenFd, path);                    }                    else if (strcmp("D", command) == 0) {                        int newListenFd = commandD(listenFd, clientAddr);                        bzero(command, max);                        while ((readResult = read(newListenFd, command, max)) > 0) {                            if (strncmp(command, "L", 1) == 0) {                                commandL(newListenFd);                            }                            else if (strncmp(command, "G", 1) == 0) {                                commandG(newListenFd, command);                            }                            else if (strncmp(command, "P", 1) == 0) {                                commandP(newListenFd, command);                            }                            else if (strncmp(command, "E", 1) == 0) {                                close(newListenFd);                            }                            close(newListenFd);                            break;                        }                    }                    else {                        char temp[] = "I got your command ";                        strcat(temp, command);                        printf("---got %s\n", temp);                        write(listenFd, temp, strlen(temp));                    }                }                bzero(command, max);            }        }        else {            printf("Parent: spawned child %d, waiting for new connection\n", pid);            wait(&status);            close(listenFd);        }    }}void commandG(int newLisFd, char* command) {    char pathName[strlen(command) - 1];    char *temp = command + 1;    strcpy(pathName, temp);    if (!isFileExist(pathName)) {        char *message = "Efile does not exist";        printf("Child %d: Sending acknowledgement -> %s\n", getpid(), message);        write(newLisFd, message, strlen(message));        return;    }    if (isDirectory(pathName)) {        printf("Child %d: Attempt to read directory\n", getpid());        char *message = "EFile is a directory";        printf("Child %d: Sending acknowledgement -> %s\n", getpid(), message);        write(newLisFd, message, strlen(message));    }    else if (isReg(pathName)) {        FILE* file = fopen(pathName, "r");        int readSize = 512;        char fileContent[readSize];        while (1) {  // read from file and write to client            int readResult = fread(fileContent, 1, readSize, file);            if (readResult == 0) // end of the file                break;            printf("Child %d: Writing %d bytes to client\n", getpid(), readResult);            write(newLisFd, fileContent, readResult);        }        fclose(file);        if (debug)            printf("Child %d: get command completed\n", getpid());    }    else {        char *message = "EDoes not have permission to read file <%s>";        printf("Child %d: Sending acknowledgement -> %s\n", getpid(), message);        write(newLisFd, message, strlen(message));    }}void commandL(int newLisFd) {    int stdOut = dup(STDOUT_FILENO);    int pid = fork();    if (pid != 0) {        if (debug)            printf("Child %d: forking ls process\n", getpid());        wait(&pid);        dup2(stdOut, STDOUT_FILENO);        close(stdOut);        if(debug)            printf("Child %d: ls command completed\n", getpid());        return;    }    else {        dup2(newLisFd, STDOUT_FILENO);  // redirect output to the given fd        close(newLisFd);        char *arg = "-l";        char *command = "ls";        if (execlp(command, command, arg, NULL) < 0) {            printf("%s\n", strerror(errno));        }        printf("Error occurred during 'execlp'\n");    }}void commandP(int sockfd, char *path) {    char pathName[strlen(path) - 1];    char *temp = path + 1;    strcpy(pathName, temp);    printf("path -> <%s>\n", pathName);    if (isFileExist(pathName)) {        char *message = "EFile already exist in server local directory";        printf("Child %d: Sending acknowledgement -> %s\n", getpid(), message);        write(sockfd, message, strlen(message));        return;    }    printf("Child %d: Sending acknowledgement -> 'A'\n", getpid());    write(sockfd, "A", 1);    FILE* fp = fopen(pathName, "w");    if (fp == NULL) {        fprintf(stderr, "Error: %s\n", strerror(errno));        return;    }    char readBuffer[512];    int result;    while ((result = read(sockfd, readBuffer, 512)) > 0) {        printf("Read %d bytes from client, writing to local file\n", result);        fputs(readBuffer, fp);    }    fclose(fp);}int commandD(int listenFd, struct sockaddr_in clientAddr) {    int socketFd2;    // make a socket    socketFd2 = socket(AF_INET, SOCK_STREAM, 0);    if (socketFd2 < 0) {        fprintf(stderr, "Error: %s\n", strerror(errno));        exit(1);    }    if (debug)        printf("Child %d: data socket created with descriptor %d\n", getpid(), socketFd2);    struct sockaddr_in servAddr2;    memset(&servAddr2, 0, sizeof(servAddr2));    servAddr2.sin_family = AF_INET;    servAddr2.sin_addr.s_addr = htonl(INADDR_ANY);    servAddr2.sin_port = htons(0); // wildcard    if (bind(socketFd2, (struct sockaddr *) &servAddr2, sizeof(servAddr2)) < 0) {        fprintf(stderr, "Error: %s\n", strerror(errno));        exit(1);    }    socklen_t length2 = sizeof(servAddr2);    if (getsockname(socketFd2, (struct sockaddr *) &servAddr2, &length2) == -1) {        fprintf(stderr, "Error: %s\n", strerror(errno));    }    else {        int newPort = (int) ntohs(servAddr2.sin_port);        printf("Child %d: Data socket bound to port %d\n", getpid(), newPort);        // Listen and Accept connections        if (listen(socketFd2, 0) < 0) {            fprintf(stderr, "Error: %s\n", strerror(errno));            exit(1);        }        char sendPort[max];        if (sprintf(sendPort, "%d", newPort) < 0) {            printf("Failed to convert port number %d to string\n", newPort);        }        char send[max];        strcpy(send, "A");        strncat(send, sendPort, strlen(sendPort));        write(listenFd, send, strlen(send));        int listenFd2, length2;        printf("Child %d: listening on data socket\n", getpid());        while(1) {            if ((listenFd2 = accept(socketFd2, (struct sockaddr *) &clientAddr, &length2)) < 0) {                fprintf(stderr, "Error: %s\n", strerror(errno));            }            write(listenFd2, "A", 1);            printf("Child %d: Sending acknowledgement -> %s\n", getpid(), send);            if (debug) {                printf("Child %d: Accepted connection from host %s on the data socket with descriptor %d\n", getpid(), hostName, listenFd2);                printf("Child %d: Data socket port number on the client end is %d\n", getpid(), ntohs(clientAddr.sin_port));                printf("Child %d: Sending positive acknowledgement\n", getpid());            }            return listenFd2;        }    }}void commandC(int socketFd, char *path) {    if (isDirectory(path)) {        if (chdir(path) == 0) {            if (debug) {                printf("Child %d: Changed current directory to %s\n", getpid(), path);            }            printf("Child %d: Sending positive acknowledgement\n", getpid());            write(socketFd, "A", 1);            return;        }        else {            char *message = "E";            strncat(message, strerror(errno), strlen(strerror(errno)));            write(socketFd, message, strlen(message));            return;        }    }    char *message = "Ethe given path is not a directory - ignored";    write(socketFd, message, strlen(message));    printf("Child %d: the given path <%s> is not a directory - ignored\n", getpid(), path);}bool isNumber(const char argv[]) {    for (int i = 0; i < strlen(argv); i++) {        if (!isdigit(argv[i]))            return false;    }    return true;}